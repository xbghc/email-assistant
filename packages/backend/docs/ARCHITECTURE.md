# 🏗️ 系统架构说明

## 概述

Email Assistant 采用现代化的 TypeScript 全栈架构，基于依赖注入模式构建了高度模块化的后端系统。

## 整体架构

### 技术栈
- **后端**: Node.js + Express.js + TypeScript
- **前端**: Vue 3 + TypeScript + Vite
- **共享**: TypeScript 类型定义
- **构建**: PNPM Monorepo + ESNext 模块

### 项目结构
```
email-assistant/
├── packages/
│   ├── backend/          # Express.js 后端服务
│   ├── frontend/         # Vue 3 前端应用
│   └── shared/           # 共享类型定义
├── CLAUDE.md            # 开发指南
└── README.md            # 项目文档
```

## 后端架构

### 依赖注入模式
采用手动依赖注入，实现松耦合的服务架构：

```
应用启动 → 初始化服务 → 注入依赖 → 启动调度器
```

### 核心服务层

#### 系统核心服务
- **`SchedulerService`** - 任务调度协调器
  - 使用 node-cron 管理定时任务
  - 协调各种提醒和报告生成
  - 处理邮件回复和 AI 分析

- **`SystemHealthService`** - 系统健康监控
  - 监控服务状态和性能指标
  - 提供健康检查端点
  - 性能数据收集

- **`SystemStartupService`** - 系统启动管理
  - 发送启动/停止通知
  - 管理系统生命周期事件

#### 业务逻辑服务
- **`EmailService`** - 邮件服务
  - 支持 SMTP 发送和 IMAP 接收
  - 实现熔断器模式防止服务过载
  - 邮件模板管理和内容生成

- **`AIService`** - AI 服务抽象层
  - 支持多 AI 提供商（OpenAI、DeepSeek、Google、Anthropic、Azure）
  - 统一的 AI 接口和错误处理
  - 请求统计和性能监控

- **`UserService`** - 用户管理
  - JWT 认证和授权
  - 用户偏好设置管理
  - 角色权限控制

#### 数据管理服务
- **`ContextService`** - 上下文管理
  - 对话历史存储和检索
  - 自动上下文压缩
  - 用户隔离的数据管理

- **`PerformanceMonitorService`** - 性能监控
  - 系统资源使用统计
  - API 响应时间监控
  - 错误率统计

### 路由层
- **`/api/auth`** - 认证相关路由
- **`/api/users`** - 用户管理路由
- **`/api/schedule`** - 日程管理路由
- **`/api/system`** - 系统监控路由
- **`/api/admin`** - 管理员功能路由
- **`/test/*`** - 测试功能路由

### 中间件
- **`authMiddleware`** - JWT 认证验证
- **CORS** - 跨域请求处理
- **Helmet** - 安全头部设置
- **体积限制** - 请求体大小限制

## 前端架构

### Vue 3 组件架构
- **组合式 API** - 使用 `<script setup>` 语法
- **TypeScript** - 完整类型支持
- **响应式状态管理** - 基于 Vue 3 Reactivity
- **路由守卫** - 认证状态检查

### 工具函数模块
- **`api.ts`** - 统一的 API 客户端
- **`auth.ts`** - 认证状态管理
- **`state.ts`** - 应用状态管理
- **`dom.ts`** - DOM 操作工具

### 页面组件
- **Dashboard** - 系统概览和状态
- **Users** - 用户管理界面
- **Settings** - 系统设置
- **Logs** - 日志查看
- **Reports** - 报告查看

## 数据层

### 文件存储
当前使用 JSON 文件存储，位于 `packages/backend/data/`：
- **`context.json`** - 对话上下文数据
- **`email-records.json`** - 邮件记录
- **`performance-metrics.json`** - 性能指标
- **`reminder-tracking.json`** - 提醒跟踪
- **`users.json`** - 用户数据

### 数据特性
- **用户隔离** - 按用户 ID 分离数据
- **自动备份** - 文件更新时创建备份
- **错误恢复** - 损坏文件自动恢复
- **并发安全** - 文件锁机制

## 通信机制

### API 通信
- **RESTful API** - 标准 HTTP 方法
- **JSON 格式** - 统一的数据交换格式
- **JWT 认证** - 无状态认证机制

### 邮件集成
- **IMAP 监听** - 实时接收邮件
- **SMTP 发送** - 支持多种邮件服务商
- **模板系统** - 动态邮件内容生成

### AI 集成
- **多提供商支持** - 统一接口抽象
- **错误处理** - 自动重试和降级
- **使用统计** - 请求量和成本跟踪

## 安全架构

### 认证授权
- **JWT Token** - 无状态身份验证
- **角色权限** - 基于角色的访问控制
- **密码安全** - bcrypt 哈希加密

### 网络安全
- **CORS 配置** - 跨域请求控制
- **安全头部** - Helmet.js 安全中间件
- **请求限制** - 防止 DDoS 攻击

### 数据安全
- **敏感信息保护** - 环境变量存储密钥
- **日志脱敏** - 避免记录敏感信息
- **输入验证** - 防止注入攻击

## 监控和日志

### 日志系统
- **Winston 日志** - 结构化日志记录
- **日志轮转** - 自动管理日志文件大小
- **分级记录** - error、warn、info、debug

### 监控指标
- **系统资源** - CPU、内存使用率
- **应用性能** - 响应时间、请求量
- **服务状态** - 邮件、AI 服务可用性

### 健康检查
- **`/health`** - 基础健康状态
- **`/api/system/status`** - 详细系统信息
- **自动监控** - 服务状态实时检测

## 扩展性设计

### 服务扩展
- **插件化架构** - 新服务容易集成
- **接口抽象** - 便于更换实现
- **配置驱动** - 运行时配置调整

### 数据库迁移
- **抽象数据层** - 便于迁移到数据库
- **数据模型定义** - 明确的数据结构
- **迁移脚本** - 数据转换工具

### 微服务拆分
- **服务边界清晰** - 便于未来拆分
- **无状态设计** - 支持水平扩展
- **API 网关就绪** - 统一入口设计

## 性能优化

### 后端优化
- **连接池** - 邮件和数据库连接复用
- **缓存策略** - 内存缓存热点数据
- **异步处理** - 非阻塞 I/O 操作

### 前端优化
- **代码分割** - Vite 自动分包
- **懒加载** - 按需加载组件
- **静态资源优化** - 压缩和缓存

### 网络优化
- **GZIP 压缩** - 减少传输数据量
- **CDN 就绪** - 静态资源分发
- **HTTP/2 支持** - 多路复用

---

**文档版本**: v1.0.0  
**最后更新**: 2025-07-12