# 用户通知系统功能说明

## 📧 功能概述

邮件助手系统现在支持向所有用户（包括非管理员用户）发送系统状态通知，让用户及时了解系统的启动、停止和维护状态。

## 🎯 通知类型

### 1. 系统启动通知 🎉
当系统重新启动时，所有活跃用户都会收到通知邮件。

**通知内容包括：**
- 系统启动时间
- AI助手类型（OpenAI/DeepSeek等）
- 服务状态确认
- 可用功能介绍
- 使用指南

**邮件主题：** `🎉 邮件助手系统已重新上线`

### 2. 系统停止通知 ⚠️
当系统进行维护或停止服务时，用户会收到提前通知。

**通知内容包括：**
- 维护开始时间
- 维护类型说明
- 预计恢复时间
- 数据安全保证
- 服务恢复通知承诺

**邮件主题：** `⚠️ 邮件助手系统维护通知`

### 3. 测试通知 🧪
管理员可以发送测试通知验证系统功能。

**邮件主题：** `🧪 邮件助手系统测试通知`

## 🔧 管理员功能

### API端点

#### 测试用户通知
```bash
POST /test/user-notifications
```
向第一个活跃用户发送测试通知，验证通知系统是否正常工作。

#### 测试系统启动通知
```bash
POST /test/startup-notification
```
手动触发完整的系统启动通知（管理员 + 所有用户）。

#### 测试系统停止通知
```bash
POST /test/shutdown-notification
```
手动触发完整的系统停止通知（管理员 + 所有用户）。

### 使用示例

```bash
# 测试用户通知功能
curl -X POST http://localhost:3000/test/user-notifications

# 测试系统启动通知
curl -X POST http://localhost:3000/test/startup-notification

# 测试系统停止通知
curl -X POST http://localhost:3000/test/shutdown-notification
```

## 📊 通知统计和日志

### 日志记录
系统会记录详细的通知发送日志：

```
[时间] info: User startup notifications sent: 5 success, 0 failed
[时间] info: Email sent successfully to user user@example.com: 🎉 邮件助手系统已重新上线
```

### 成功率统计
- 成功发送数量
- 失败发送数量
- 失败原因记录

## 🛡️ 安全特性

### 用户过滤
- 只向**活跃用户**发送通知
- 自动跳过已禁用的账户
- 避免向无效邮箱发送

### 错误处理
- 单个用户发送失败不影响其他用户
- 详细的错误日志记录
- 自动重试机制（计划中）

### 内容优化
- 自动内容长度优化
- 统一的邮件格式
- 防止垃圾邮件标记

## 🎨 通知内容定制

### 启动通知模板
```
您好 [用户名]，

邮件助手系统已成功重新启动，现在可以正常为您提供服务了！

🕐 启动时间：[时间]
🤖 AI 助手：[AI提供商]
✨ 服务状态：所有功能正常运行

您可以：
• 发送工作报告，我将为您生成智能总结
• 接收每日日程提醒和个性化建议
• 通过邮件与AI助手互动
• 管理您的提醒时间设置

如果您有任何问题或需要帮助，请随时回复此邮件。

祝您工作愉快！

此致，
您的邮件助手
```

### 停止通知模板
```
您好 [用户名]，

邮件助手系统将进行维护，暂时无法提供服务。

🕐 维护时间：[时间]
🔧 维护类型：系统更新/重启
⏱️ 预计恢复：维护完成后系统将自动恢复服务

在此期间：
• 您发送的邮件将在系统恢复后处理
• 定时提醒将在恢复后正常发送
• 所有数据都已安全保存

系统恢复后，您将收到确认通知。给您带来的不便，我们深表歉意。

感谢您的理解与支持！

此致，
邮件助手系统
```

## 🔄 自动化流程

### 系统启动时
1. 验证邮件服务连接
2. 初始化用户服务
3. 发送管理员通知
4. 发送用户通知
5. 记录统计信息

### 系统停止时
1. 接收系统信号（SIGINT）
2. 发送管理员通知
3. 发送用户通知
4. 优雅关闭服务

## 📈 性能考虑

### 批量发送优化
- 避免同时发送大量邮件
- 错误隔离（单个失败不影响整体）
- 异步处理（计划中）

### 资源管理
- 邮件内容优化减少带宽
- 合理的超时设置
- 连接池管理

## 🚀 未来改进计划

### 短期计划
- [ ] 添加邮件发送队列
- [ ] 实现异步批量发送
- [ ] 添加重试机制
- [ ] 支持邮件模板定制

### 长期计划
- [ ] 支持多种通知渠道（微信、短信等）
- [ ] 用户通知偏好设置
- [ ] 通知历史记录查询
- [ ] 实时通知状态监控

## 🐛 故障排除

### 常见问题

**Q: 用户收不到通知邮件？**
A: 检查：
1. 用户账户是否为活跃状态
2. 邮箱地址是否正确
3. SMTP配置是否正确
4. 查看系统日志中的错误信息

**Q: 通知发送缓慢？**
A: 
1. 检查网络连接
2. 验证SMTP服务器响应时间
3. 考虑减少单次发送的用户数量

**Q: 部分用户收不到通知？**
A: 
1. 查看日志中的失败记录
2. 验证失败用户的邮箱设置
3. 检查邮件服务器限制

### 调试命令

```bash
# 查看系统日志
tail -f logs/app.log | grep "notification"

# 测试单个用户通知
curl -X POST http://localhost:3000/test/user-notifications

# 查看用户统计
curl http://localhost:3000/health
```

---

*文档更新时间: 2024-07-04*
*版本: v1.0.0*